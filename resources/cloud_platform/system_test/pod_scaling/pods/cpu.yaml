apiVersion: v1
kind: Pod
metadata:
  name: cpu-stress-app
  labels:
    app: cpu-stress-app
spec:
  restartPolicy: OnFailure
  containers:
  - name: cpu-stress-app
    image: alexeiled/stress-ng
    imagePullPolicy: IfNotPresent
    command: ["/stress-ng"]
    args: ["--cpu", "$(REQ_CPU)", "--metrics-brief", "--timeout", "48h", "-v", "--log-file", "/output/$(POD_NAME)-$(NODE_NAME).log", "--yaml", "/output/$(POD_NAME)-$(NODE_NAME).yaml" ]
    volumeMounts:
      - name: scratch-volume
        mountPath: /scratch
      - name: output-volume
        mountPath: /output
    resources:
      requests:
        cpu: 2
        memory: "1Gi"
      limits:
        cpu: 2
        memory: "1Gi"
    env:
      - name: NODE_NAME
        valueFrom:
          fieldRef:
            fieldPath: spec.nodeName
      - name: POD_NAME
        valueFrom:
          fieldRef:
            fieldPath: metadata.name
      - name: REQ_CPU
        valueFrom:
          resourceFieldRef:
            containerName: cpu-stress-app
            resource: requests.cpu
      - name: REQ_MEM
        valueFrom:
          resourceFieldRef:
            containerName: cpu-stress-app
            resource: requests.memory
      - name: LIM_CPU
        valueFrom:
          resourceFieldRef:
            containerName: cpu-stress-app
            resource: limits.cpu
      - name: LIM_MEM
        valueFrom:
          resourceFieldRef:
            containerName: cpu-stress-app
            resource: limits.memory
  volumes:
    - name: scratch-volume
      emptyDir:
        medium: Memory
        sizeLimit: 1Gi
    - name: output-volume
      hostPath:
        path: "/home/sysadmin/stress"